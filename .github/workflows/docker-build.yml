name: Docker Build and Push

#
# Multi-architecture Docker image build and push to GitHub Container Registry
# Triggers: Push to master, Git tags, Manual dispatch
# Platforms: linux/amd64, linux/arm64
#

on:
  push:
    branches:
      - master
    tags:
      - 'v*'
      - 'version-*'
  workflow_dispatch:
    inputs:
      tag_suffix:
        description: 'Optional tag suffix (e.g., "test")'
        required: false
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: thpham/serles-acme

jobs:
  # ==========================================================================
  # Build and Push Docker Image
  # ==========================================================================
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      # ------------------------------------------------------------------------
      # Checkout code
      # ------------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git describe

      # ------------------------------------------------------------------------
      # Set up build environment
      # ------------------------------------------------------------------------
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest

      # ------------------------------------------------------------------------
      # Login to GitHub Container Registry
      # ------------------------------------------------------------------------
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ------------------------------------------------------------------------
      # Generate image tags
      # ------------------------------------------------------------------------
      - name: Generate image tags
        id: meta
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
          TAGS=""

          # Extract git info
          GIT_SHA=$(git rev-parse --short HEAD)
          GIT_TAG="${GITHUB_REF#refs/tags/}"

          echo "Git SHA: $GIT_SHA"
          echo "Git Ref: $GITHUB_REF"

          # Determine tags based on trigger
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            # Release tag (e.g., v1.2.0)
            VERSION="${GIT_TAG#v}"
            TAGS="${IMAGE}:${VERSION},${IMAGE}:latest"
            echo "Detected release tag: $VERSION"

          elif [[ "$GITHUB_REF" == refs/tags/version-* ]]; then
            # Version tag (e.g., version-abc123)
            TAGS="${IMAGE}:${GIT_TAG}"
            echo "Detected version tag: $GIT_TAG"

          elif [[ "$GITHUB_REF" == refs/heads/master ]]; then
            # Push to master - create version-{short_sha} tag
            VERSION_TAG="version-${GIT_SHA}"
            TAGS="${IMAGE}:${VERSION_TAG}"
            echo "Master branch push: $VERSION_TAG"

          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # Manual dispatch
            if [[ -n "${{ inputs.tag_suffix }}" ]]; then
              TAGS="${IMAGE}:${{ inputs.tag_suffix }}-${GIT_SHA}"
            else
              TAGS="${IMAGE}:manual-${GIT_SHA}"
            fi
            echo "Manual dispatch: ${TAGS}"

          else
            # Fallback
            TAGS="${IMAGE}:${GIT_SHA}"
            echo "Fallback: ${GIT_SHA}"
          fi

          # Output tags
          echo "tags=${TAGS}" >> $GITHUB_OUTPUT
          echo "version_tag=version-${GIT_SHA}" >> $GITHUB_OUTPUT
          echo "Generated tags: $TAGS"

      # ------------------------------------------------------------------------
      # Extract metadata
      # ------------------------------------------------------------------------
      - name: Extract metadata
        id: docker_meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          labels: |
            org.opencontainers.image.title=Serles ACME Server
            org.opencontainers.image.description=ACME Server with EJBCA CE PKI integration
            org.opencontainers.image.vendor=thpham

      # ------------------------------------------------------------------------
      # Build and push image
      # ------------------------------------------------------------------------
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.docker_meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1

      # ------------------------------------------------------------------------
      # Create git tag for version-{sha} on master push
      # ------------------------------------------------------------------------
      - name: Create version tag
        if: github.ref == 'refs/heads/master' && github.event_name == 'push'
        run: |
          VERSION_TAG="${{ steps.meta.outputs.version_tag }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$VERSION_TAG" -m "Automated version tag for commit ${GITHUB_SHA::7}"
          git push origin "$VERSION_TAG"

  # ==========================================================================
  # Cleanup Old Tags
  # ==========================================================================
  cleanup-tags:
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    permissions:
      packages: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Delete old version tags
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get all version-* tags from GHCR
          PACKAGE_URL="https://api.github.com/users/thpham/packages/container/serles-acme/versions"

          echo "Fetching package versions..."
          VERSIONS=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" "$PACKAGE_URL")

          # Extract version-* tags and their IDs
          VERSION_TAGS=$(echo "$VERSIONS" | jq -r '.[] | select(.metadata.container.tags[] | startswith("version-")) | {id: .id, tags: .metadata.container.tags} | @json')

          if [[ -z "$VERSION_TAGS" ]]; then
            echo "No version-* tags found"
            exit 0
          fi

          # Count version tags
          TAG_COUNT=$(echo "$VERSION_TAGS" | wc -l)
          echo "Found $TAG_COUNT version-* tags"

          # Keep only the last 4, delete the rest
          if [[ $TAG_COUNT -gt 4 ]]; then
            TAGS_TO_DELETE=$(echo "$VERSION_TAGS" | head -n -4)

            echo "Deleting old tags (keeping last 4)..."
            echo "$TAGS_TO_DELETE" | while read -r VERSION_JSON; do
              VERSION_ID=$(echo "$VERSION_JSON" | jq -r '.id')
              VERSION_TAG=$(echo "$VERSION_JSON" | jq -r '.tags[0]')

              echo "Deleting tag: $VERSION_TAG (ID: $VERSION_ID)"
              curl -X DELETE \
                -H "Authorization: Bearer $GITHUB_TOKEN" \
                "https://api.github.com/users/thpham/packages/container/serles-acme/versions/$VERSION_ID" || echo "Failed to delete $VERSION_TAG"
            done

            echo "Cleanup complete!"
          else
            echo "Less than 4 version-* tags exist, no cleanup needed"
          fi

      # Clean up git tags locally (keep last 4)
      - name: Clean up git version tags
        run: |
          echo "Cleaning up git tags..."
          VERSION_TAGS=$(git tag -l "version-*" | sort -V)
          TAG_COUNT=$(echo "$VERSION_TAGS" | wc -l)

          echo "Found $TAG_COUNT git version-* tags"

          if [[ $TAG_COUNT -gt 4 ]]; then
            TAGS_TO_DELETE=$(echo "$VERSION_TAGS" | head -n -4)

            echo "Deleting old git tags (keeping last 4)..."
            echo "$TAGS_TO_DELETE" | while read -r TAG; do
              echo "Deleting git tag: $TAG"
              git push --delete origin "$TAG" || echo "Failed to delete $TAG"
            done

            echo "Git tag cleanup complete!"
          else
            echo "Less than 4 git version-* tags exist, no cleanup needed"
          fi
