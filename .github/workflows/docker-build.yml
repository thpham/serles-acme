name: Docker Build and Push

#
# Native multi-architecture Docker image build and push to GitHub Container Registry
# Uses native runners (amd64, arm64) instead of QEMU emulation for faster builds
#
# Triggers: Push to master, Git release tags (v*), Manual dispatch
# Image Tags:
#   - Master commits: v{version}-{short_sha}, latest
#   - Release tags: v{version}, latest
#   - Manual: v{version}-{short_sha}-{suffix}
#

on:
  push:
    branches:
      - master
    tags:
      - "v*"
    paths-ignore:
      - "**.md"
      - "**.rst"
      - "docs/**"
      - "LICENSE"
      - ".gitignore"
  workflow_dispatch:
    inputs:
      tag_suffix:
        description: 'Optional tag suffix (e.g., "test", "rc1")'
        required: false
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: thpham/serles-acme

jobs:
  # ==========================================================================
  # Extract Version from setup.py
  # ==========================================================================
  extract-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      short_sha: ${{ steps.get_version.outputs.short_sha }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version from setup.py
        id: get_version
        run: |
          # Extract version from setup.py (BSD/GNU compatible)
          VERSION=$(grep 'version=' setup.py | sed -E 's/.*version="([^"]+)".*/\1/')
          SHORT_SHA=$(git rev-parse --short HEAD)

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT

          echo "ðŸ“¦ App Version: ${VERSION}"
          echo "ðŸ”– Git SHA: ${SHORT_SHA}"

  # ==========================================================================
  # Build Docker Images for Each Architecture (Native Runners)
  # ==========================================================================
  build-arch-matrix:
    needs: extract-version
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read
      packages: write

    strategy:
      matrix:
        include:
          - runner: ubuntu-latest
            platform: linux/amd64
            arch: amd64
          - runner: ubuntu-24.04-arm
            platform: linux/arm64
            arch: arm64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push by digest
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: ${{ matrix.platform }}
          push: true
          outputs: type=image,name=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }},push-by-digest=true,name-canonical=true,push=true
          cache-from: type=gha,scope=${{ matrix.arch }}
          cache-to: type=gha,mode=max,scope=${{ matrix.arch }}
          build-args: |
            BUILDKIT_INLINE_CACHE=1

      - name: Export digest
        run: |
          mkdir -p /tmp/digests
          digest="${{ steps.build.outputs.digest }}"
          touch "/tmp/digests/${digest#sha256:}"
          echo "ðŸ—ï¸  Built ${{ matrix.platform }}: ${digest}"

      - name: Upload digest
        uses: actions/upload-artifact@v4
        with:
          name: digests-${{ matrix.arch }}
          path: /tmp/digests/*
          if-no-files-found: error
          retention-days: 1

  # ==========================================================================
  # Create Multi-Architecture Manifest and Apply Tags
  # ==========================================================================
  create-manifest:
    needs: [extract-version, build-arch-matrix]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Download digests
        uses: actions/download-artifact@v4
        with:
          path: /tmp/digests
          pattern: digests-*
          merge-multiple: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate image tags
        id: tags
        env:
          VERSION: ${{ needs.extract-version.outputs.version }}
          SHORT_SHA: ${{ needs.extract-version.outputs.short_sha }}
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
          TAGS=""

          echo "ðŸ“‹ Build Context:"
          echo "  Version: ${VERSION}"
          echo "  Short SHA: ${SHORT_SHA}"
          echo "  Git Ref: ${GITHUB_REF}"
          echo "  Event: ${GITHUB_EVENT_NAME}"
          echo ""

          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            # Release tag build: v{version}, latest
            GIT_TAG="${GITHUB_REF#refs/tags/}"
            RELEASE_VERSION="${GIT_TAG#v}"

            # Validate version matches setup.py
            if [[ "${RELEASE_VERSION}" != "${VERSION}" ]]; then
              echo "âŒ ERROR: Git tag version (${RELEASE_VERSION}) does not match setup.py version (${VERSION})"
              exit 1
            fi

            TAGS="${IMAGE}:v${VERSION},${IMAGE}:latest"
            echo "ðŸ·ï¸  Release Tag Build"
            echo "  Tags: v${VERSION}, latest"

          elif [[ "${GITHUB_REF}" == refs/heads/master ]]; then
            # Master branch build: v{version}-{sha}, latest
            TAGS="${IMAGE}:v${VERSION}-${SHORT_SHA},${IMAGE}:latest"
            echo "ðŸ·ï¸  Master Branch Build"
            echo "  Tags: v${VERSION}-${SHORT_SHA}, latest"

          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # Manual dispatch build
            if [[ -n "${{ inputs.tag_suffix }}" ]]; then
              TAGS="${IMAGE}:v${VERSION}-${SHORT_SHA}-${{ inputs.tag_suffix }}"
              echo "ðŸ·ï¸  Manual Dispatch Build (with suffix)"
              echo "  Tag: v${VERSION}-${SHORT_SHA}-${{ inputs.tag_suffix }}"
            else
              TAGS="${IMAGE}:v${VERSION}-${SHORT_SHA}"
              echo "ðŸ·ï¸  Manual Dispatch Build"
              echo "  Tag: v${VERSION}-${SHORT_SHA}"
            fi

          else
            # Fallback for other branches
            TAGS="${IMAGE}:v${VERSION}-${SHORT_SHA}"
            echo "ðŸ·ï¸  Branch Build"
            echo "  Tag: v${VERSION}-${SHORT_SHA}"
          fi

          echo ""
          echo "tags=${TAGS}" >> $GITHUB_OUTPUT
          echo "âœ… Final Tags: ${TAGS}"

      - name: Create manifest list and push
        working-directory: /tmp/digests
        run: |
          TAGS="${{ steps.tags.outputs.tags }}"

          # Convert comma-separated tags to -t flag format
          TAG_FLAGS=""
          IFS=',' read -ra TAG_ARRAY <<< "$TAGS"
          for tag in "${TAG_ARRAY[@]}"; do
            TAG_FLAGS="${TAG_FLAGS} -t ${tag}"
          done

          echo "ðŸ”¨ Creating multi-arch manifest with tags:"
          for tag in "${TAG_ARRAY[@]}"; do
            echo "  - ${tag}"
          done
          echo ""

          # Create manifest from digests
          docker buildx imagetools create ${TAG_FLAGS} \
            $(printf '${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@sha256:%s ' *)

          echo ""
          echo "âœ… Multi-architecture manifest created successfully!"

      - name: Inspect image
        run: |
          TAGS="${{ steps.tags.outputs.tags }}"
          FIRST_TAG=$(echo "$TAGS" | cut -d',' -f1)

          echo "ðŸ” Inspecting multi-arch image: ${FIRST_TAG}"
          echo ""
          docker buildx imagetools inspect "${FIRST_TAG}"

      - name: Build summary
        run: |
          echo "## ðŸŽ‰ Docker Build Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`v${{ needs.extract-version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ needs.extract-version.outputs.short_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Images Pushed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          TAGS="${{ steps.tags.outputs.tags }}"
          IFS=',' read -ra TAG_ARRAY <<< "$TAGS"
          for tag in "${TAG_ARRAY[@]}"; do
            echo "- \`${tag}\`" >> $GITHUB_STEP_SUMMARY
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ—ï¸ Architectures" >> $GITHUB_STEP_SUMMARY
          echo "- linux/amd64 (native ubuntu-latest)" >> $GITHUB_STEP_SUMMARY
          echo "- linux/arm64 (native ubuntu-24.04-arm64)" >> $GITHUB_STEP_SUMMARY
